# Overview

Chromium的网络栈代码主要位于代码库`src/net`下面，负责整个浏览器的网络功能，代码主要实现了DNS, http和https，以及quic和spdy等协议。另外在`src/services/network`目录下面也有网络栈的代码，这部分代码是对src/net目录下代码的一个mojo封装，使之具备mojo通信的功能。`src/services/network`的顶层对象是`network::NetworkService`，然后`src/net`的顶层对象是`net::URLRequestContext`。

## network 模块

`src/services/network`模块的顶层对象是`network::NetworkService`。

Chromium会在content中的utility/services.cc中初始化NetworkService，然后在network::mojom::NetworkServiceStubDispatch::Accept()方法中会调用CreateNetworkContext。

NetworkService
NetworkContext
NetworkContextParams
创建：CreateInProcessNetworkServiceOnThread
销毁：ShutDownNetworkService()

## net 模块

`src/net`模块的顶层对象是`net::URLRequestContext`

## Life of a Simple URLRequest

在Chromium的多进程架构中，网络请求会来源于其他的进程，典型的就是renderer进程。如果一个网络请求被派发到net模块中，那么就会在network service中创建一个network::URLLoader，然后这个network::URLLoader会创建一个URLRequest来驱动整个网络请求。URLLoader会创建一个Job，这个Job首先会检查HTTP cache，然后创建一个NetworkTransaction对象。这里的NetworkTransaction会尽可能地重用connection（这里的connection具体是什么意思呢？）。如果说，没有可以重用的connection就会重新建立一个。一旦connection建立好，就会发起HTTP请求，然后就是解析HTTP响应，最后将结果返回给调用者。

当然，真正发生的一切不会这么简单。

假设一种简单的HTTP请求情况：

1. HTTP协议请求，不涉及TLS/SSL协议。
2. HTTP响应没有压缩。
3. HTTP Cache没有对应的条目
4. Socket pool中没有闲置的连接，也就是需要重新创建TCP连接。

### 1. 由其他进程(非网络进程)发起请求

Summary:

1. 在浏览器进程，network::mojom::NetworkContext接口会创建network::mojom::URLLoaderFactory.
2. 消费者（例如，blink中的content::ResourceDispatcher, content::NavigationURLLoaderImpl, network::SimpleURLLoader）会将一个network::ResourceRequest对象和一个network::mojom::URLLoaderClient对象传递给network::mojom::URLLoaderFactory。然后network::mojom::URLLoaderFactory会创建一个network::mojom::URLLoader.
3. network::ResourceReqeust会通过mojo的IPC管道从其他的进程传递到网络进程中的network::URLLoaderFactory.

Chrome有一个唯一的浏览器进程（至少目前是这样的），它主要负责创建和初始化其他的进程、标签管理，地址导航等功能。由浏览器进程创建的子进程主要有（renderer，GPU，plguin，network, etc.）这些进程都被隔离在沙盒中，network之外的进程没有访问网络的权限。这些进程必须通过mojo机制向network进程发起请求，然后由network去处理网络栈的逻辑。

浏览器进程会创建network::mojom::NetworkContext对象，这个对象是network service非常顶层的对象，只能在浏览器进程中访问。浏览器进程会通过network::mojom::NetworkContext创建非特权的network::mojom::URLLoaderFactories，然后将其通过mojo传递给其他进程。其他进程通过network::mojom::URLLoaderFactories创建network::mojom::URLLoader。

network消费者要么位于浏览器进程，要么位于其他的进程。它们需要发起网络请求的话需要从浏览器进程获取URLLoaderFactory。当然消费者需要完成一些逻辑：

(1)消费者需要收集大量参数以便创建network::ResourceRequest对象。

(2)消费者需要创建一个network::mojom::URLLoaderClient对象，用于处理network::mojom::URLLoader的结果。

(3)消费者将network::ResourceRequest和network::mojom::URLLoaderClient传递给URLLoaderFactory，URLLoaderFactory会创建一个URLLoader用于管理后续的网络请求。

### 2. network::URLLoaderFactory在network service中设置一个request

Summay:

1. network::URLLoaderFactory创建一个network::URLLoader.
2. network::URLLoader通过network::NetworkContext的URLRequestContext创建并启动一个URLRequest.

### 3. 检查HTTP缓存，请求一个HttpStream

TODO

### 4. 创建HttpStream

TODO

### 5. 发起请求，解析响应

TODO

### 6. 响应体被读取

TODO

### 7. URLRequest对象被销毁

TODO
